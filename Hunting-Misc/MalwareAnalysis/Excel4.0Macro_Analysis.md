# Excel 4.0 Macro Samples analysis

> Paolo Coba

-------------------------------------------

## Source for Samples

* [https://github.com/jstrosch/malware-samples/tree/master/malware_analysis_exercises/2021/February](https://github.com/jstrosch/malware-samples/tree/master/malware_analysis_exercises/2021/February)

## Sample 1

1. This document is encrypted, what is the password to decrypt it?
    * [https://blogs.vmware.com/security/2020/11/velvetsweatshop-when-default-passwords-can-still-make-a-difference.html](https://blogs.vmware.com/security/2020/11/velvetsweatshop-when-default-passwords-can-still-make-a-difference.html)

```bash
msoffcrypto-tool <sample> --test -v

msoffcrypto-tool <sample> -p <password> > decrypted.bin
```

2. What command argument would you use with OLEDUMP's plugin_biff to select all records relevant for Excel 4.0 macros?

```bash
oledump.py <sample> -p plugin_biff -x
```

3. This document contains six hidden sheets, what are their names?
    * SOCWNEScLLxkLhtJp
    * OHqYbvYcqmWjJJjsF
    * Macro2
    * Macro3
    * Macro4
    * Macro5

```bash
oledump.py <sample> -p plugin_biff -x | grep "hidden"
```

4. What URL is the malware using to download the next stage?
    * "hxxp://rilaer[.]com/IfAmGZIJjbwzvKNTxSPM/ixcxmzcvqi.ex

```bash
oledump.py <sample> -p plugin_biff -x | grep "http"
xlmdeobfuscator -f <sample>
olevba <sample>
```

5. What malware family was this document attempting to drop?
    * Dridex
    * [https://urlhaus.abuse.ch/browse.php?search=rilaer.com](https://urlhaus.abuse.ch/browse.php?search=rilaer.com)

## Sample 2

1. This document has a very hidden sheet, what was it named?
    * CSHykdYHvi

```bash
oledump.py <sample> -p plugin_biff -x | grep "hidden"
```

2. This document uses reg.exe, what is the purpose?
    * CALL("Shell32","ShellExecuteA","JJCCCJJ",0,"open","C:\Windows\system32\reg.exe","EXPORT HKCU\Software\Microsoft\Office\GET.WORKSPACE(2)\Excel\Security c:\users\public\1.reg /y",0,5): Checks if macros enabled

```bash
xlmdeobfuscator -f <sample>
```

3. This document goes on to perform a number of additional anti-analysis checks, what Excel 4 macro function does it use?
    * [https://0xevilc0de.com/excel-4-macros-get-workspace-reference/](https://0xevilc0de.com/excel-4-macros-get-workspace-reference/)
    * GET.WORKSPACE(13)<770: Usable workspace width
    * GET.WORKSPACE(14)<381: Usable workspace height
    * SHARED FMLA at rowx=0 colx=1IF(GET.WORKSPACE(19): If a mouse is present, returns TRUE; otherwise, returns FALSE. 
    * SHARED FMLA at rowx=0 colx=1IF(GET.WORKSPACE(42): If your computer is capable of playing sounds, returns TRUE; otherwise, returns FALSE
    * SHARED FMLA at rowx=0 colx=1IF(ISNUMBER(SEARCH(""Windows"",GET.WORKSPACE(1))): Name of the environment in which Microsoft Excel is running, as text, followed by the environmentâ€™s version number

4. What type of payload is downloaded? How is it executed?
    * hxxps://ethelenecrace[.]xyz/fbb3: HTML payload

5. What was the payload?
    * [https://www.virustotal.com/gui/domain/ethelenecrace.xyz/community](https://www.virustotal.com/gui/domain/ethelenecrace.xyz/community)
    * ZLoader
